{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "39262471",
   "metadata": {},
   "source": [
    "# RASA教程--天气问答Demo\n",
    "\n",
    "安装rasa包，首选rasa1.0版本，本教程使用1.10.12版本。"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "2d56219c",
   "metadata": {},
   "source": [
    "### Rasa简介\n",
    "  Rasa是一个开源机器学习框架，用于构建上下文AI助手和聊天机器人。Rasa有两个主要模块：\n",
    "\n",
    "#### NLU：实现意图识别和槽值提取，它把用户的输入转换为结构化数据；\n",
    "#### Core：是一个对话管理平台，用于预测、决定下一步做什么；\n",
    "##### Rasa X是一个工具，可帮助您构建、改进和部署由Rasa框架提供支持的AI Assistants（在后面得章节会提及）\n",
    "  > ```shell\n",
    "> 注：如果出现No matching distribution found for tensorflow>=2.1.0异常，可以通过执行pip3 install --upgrade tensorflow rasa命令解决。\n",
    "  > ```"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "b7f26792",
   "metadata": {},
   "source": [
    "## 1. 初始化"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "a7e9df99",
   "metadata": {},
   "source": [
    "  > ```shell\n",
    "  > rasa init --no-prompt\n",
    "  > ```\n",
    "执行rasa init命令自动生成一个Rasa项目所需的所有必要文件，整个过程包括项目文件生成，NLU训练和对话core模型训练三个部分，训练时间根据数据量大小而定。有了这些文件我们便可以不作任何修改就能使Rasa项目跑起来，更重要的是，对于未来一些具体业务来说，也是修改这些文件的内容，这些文件名称及其作用如下表所示:\n",
    "\n",
    "|  文件名   | 简单说明  |\n",
    "|  ----  | ----  |\n",
    "| __init__.py  | 方便项目找到python路径的文件，无特别之处 |\n",
    "| actions.py  | 负责会话动作，处理对话逻辑 |\n",
    "| config.yml   | 配置NLU和core选择什么模型，以及训练的一些常规参数 |\n",
    "| credentials.yml  | 配置链接其他模块，一般不涉及 |\n",
    "| data/nlu.md  | NLU训练数据，也支持Json格式，但最新的rasa2.0版本做了统一 |\n",
    "| data/stories.md  | core模型训练数据，根据会话设计来决定每一个会话状态之间的转换 |\n",
    "| domain.yml  | 定义一些会话系统的变量，包括意图，槽位，以及一些模板回复 |\n",
    "| endpoints.yml  | 负责和聊天页面对接的channel |\n",
    "| models/<timestamp>.tar.gz  | 模型存储路径 |\n",
    "\n",
    "rasa还提供了其他命令，详情参见\n",
    "  > ```shell\n",
    "  > https://rasa.com/docs/rasa/command-line-interface/\n",
    "  > ```"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "b81e6315",
   "metadata": {},
   "source": [
    "一般中文的会设计到分词，中文embedding，因此我们回想到在rasa里是哪一部分控制NLU呢？ 是config.yaml文件，因此我们只需要改变config里的文件即可，下面我们逐行来分析一下config文件：\n",
    "  > ```shell\n",
    "  > language: en  ---指定NLU语言，en代表英文，如果我们换成中文，需要改为：zh\n",
    "  >   pipeline:\n",
    "  > - name: WhitespaceTokenizer   ---指定token的方法，英文里一般通过空格来做token，但是也有些缺陷，后续章节我们再详细介绍\n",
    " >  - name: RegexFeaturizer  ---为了提高NER效果，rasa支持自定义词典做正则匹配来做NER\n",
    " >  - name: LexicalSyntacticFeaturizer  ---下面及格组件一般成对出现，丰富语义信息\n",
    " >  - name: CountVectorsFeaturizer\n",
    " >  - name: CountVectorsFeaturizer\n",
    " >    analyzer: \"char_wb\"\n",
    " >    min_ngram: 1\n",
    " >    max_ngram: 4\n",
    " >  - name: DIETClassifier    ---做意图识别和NER的关键组件，后续我们会精读这个模型对于的论文\n",
    " >    epochs: 100       ---NLU训练的超参数\n",
    " >  - name: EntitySynonymMapper\n",
    " >  - name: ResponseSelector   ---对于一些固定回复，我们可以添加这个组件，固定回复会联想到FAQ，FAQ可以利用这个组件\n",
    " >    epochs: 100\n",
    "  > policies:  ---负责core模型训练，一般选择默认的即可\n",
    "   > - name: MemoizationPolicy\n",
    "   > - name: TEDPolicy\n",
    "   >   max_history: 5\n",
    "   >   epochs: 100\n",
    "  >  - name: MappingPolicy\n",
    "  > ```\n",
    "\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "84a514d1",
   "metadata": {},
   "source": [
    "## 2. 配置\n",
    "### 2.1 config\n",
    "```json\n",
    "language: \"zh\"\n",
    "\n",
    "pipeline:\n",
    "  - name: \"MitieNLP\"\n",
    "    model: \"../dat/total_word_feature_extractor_zh.dat\"\n",
    "  - name: \"JiebaTokenizer\"\n",
    "  - name: \"MitieEntityExtractor\"\n",
    "  - name: \"EntitySynonymMapper\"\n",
    "  - name: \"RegexFeaturizer\"\n",
    "  - name: \"MitieFeaturizer\"\n",
    "  - name: \"SklearnIntentClassifier\"\n",
    "\n",
    "policies:\n",
    "  - name: TEDPolicy\n",
    "    epochs: 500\n",
    "    max_history: 5\n",
    "  - name: FallbackPolicy\n",
    "    fallback_action_name: 'action_default_fallback'\n",
    "  - name: MemoizationPolicy\n",
    "    max_history: 5\n",
    "  - name: FormPolicy\n",
    "```"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "384c34cd",
   "metadata": {},
   "source": [
    "### 2.2 data/nlu\n",
    "\n",
    "```json\n",
    "## intent:greet\n",
    "- 你好\n",
    "- 你好啊\n",
    "- 早上好\n",
    "- 晚上好\n",
    "- hello\n",
    "- hi\n",
    "- 嗨\n",
    "- 嗨喽\n",
    "- 见到你很高兴\n",
    "- 嘿\n",
    "- 早\n",
    "- 上午好\n",
    "- hello哈喽\n",
    "- 哈喽哈喽\n",
    "- hello hello\n",
    "- 喂喂\n",
    "\n",
    "## intent:goodbye\n",
    "- goodbye\n",
    "- bye\n",
    "- bye bye\n",
    "- 88\n",
    "- 886\n",
    "- 再见\n",
    "- 拜\n",
    "- 拜拜\n",
    "- 拜拜，下次再聊\n",
    "- 下次见\n",
    "- 回头见\n",
    "- 下次再见\n",
    "- 下次再聊\n",
    "- 有空再聊\n",
    "- 先这样吧\n",
    "- 好了，就说这么多了\n",
    "- 好了，先这样\n",
    "- 没事\n",
    "\n",
    "## intent:whoareyou\n",
    "- 你是谁\n",
    "- 我知道你吗\n",
    "- 谁\n",
    "- 我认识你吗\n",
    "- 这是谁啊\n",
    "- 是谁\n",
    "- 请问你是谁\n",
    "- 请问我认识你吗\n",
    "- 你是哪位\n",
    "- 你是？\n",
    "- 是谁？\n",
    "- 可以告诉我你的名字吗\n",
    "- 你叫什么名字\n",
    "\n",
    "## intent:whattodo\n",
    "- 你支持什么功能\n",
    "- 你有什么功能\n",
    "- 你能干什么\n",
    "- 你能做什么\n",
    "\n",
    "## intent:thanks\n",
    "- 谢谢\n",
    "- thanks\n",
    "- thank you\n",
    "- 真的太感谢你了，帮了我大忙\n",
    "- 谢谢你帮了我大忙\n",
    "- 你帮了我大忙，谢谢你小智\n",
    "- 非常感谢\n",
    "- 谢了\n",
    "\n",
    "## intent:deny\n",
    "- 不\n",
    "- no\n",
    "- 不可以\n",
    "- 不是的\n",
    "- 不认同\n",
    "- 否定\n",
    "- 不是这样子的\n",
    "- 我不同意你的观点\n",
    "- 不同意\n",
    "- 不好\n",
    "- 你长得很美，就不要想得太美。\n",
    "- 拒绝\n",
    "- 不行\n",
    "\n",
    "## intent:affirm\n",
    "- 是的\n",
    "- 当然\n",
    "- 好的\n",
    "- ok\n",
    "- 嗯\n",
    "- 可以\n",
    "- 你可以这么做\n",
    "- 你做得可以啊\n",
    "- 同意\n",
    "- 听起来不错\n",
    "- 是这样的\n",
    "- 的确是这样子的\n",
    "- 我同意你的观点\n",
    "- 对的\n",
    "- 好滴\n",
    "- 行\n",
    "- 还行\n",
    "- 当然可以\n",
    "## intent: request_weather\n",
    "- 天气\n",
    "- 查询天气\n",
    "- 帮我查天气信息\n",
    "- 我想知道[明天](date-time)的天气\n",
    "- [星期一](date-time)的天气\n",
    "- [今天](date-time)的天气怎么样\n",
    "- 帮我查下[后天](date-time)的天气\n",
    "- 查下[广州](address)的天气怎么样\n",
    "-  [长沙](address)的天气\n",
    "- [深圳](address)[明天](date-time)的天气\n",
    "- 查下[今天](date-time)[上海](address)的天气\n",
    "- 帮我查查[佛山](address)这[周六](date-time)的天气\n",
    "```"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "20c5cd63",
   "metadata": {},
   "source": [
    "### 2.3 data/story\n",
    "\n",
    "```json\n",
    "## greet\n",
    "* greet\n",
    "    - utter_answer_greet\n",
    "\n",
    "## say affirm  with greet\n",
    "* greet\n",
    "    - utter_answer_greet\n",
    "* affirm\n",
    "    - utter_answer_affirm\n",
    "    \n",
    "## say affirm \n",
    "* affirm\n",
    "    - utter_answer_affirm\n",
    "    \n",
    "## say no with greet\n",
    "* greet\n",
    "    - utter_answer_greet\n",
    "* deny\n",
    "    - utter_answer_deny\n",
    "    \n",
    "## say no \n",
    "* deny\n",
    "    - utter_answer_deny\n",
    "\n",
    "\n",
    "## say goodbye\n",
    "* goodbye\n",
    "    - utter_answer_goodbye\n",
    "    \n",
    "## thanks with greet\n",
    "* greet\n",
    "    - utter_answer_greet\n",
    "* thanks\n",
    "    - utter_answer_thanks\n",
    "    \n",
    "## thanks\n",
    "* thanks\n",
    "    - utter_answer_thanks\n",
    "    \n",
    "## who are you with greet\n",
    "* greet\n",
    "    - utter_answer_greet\n",
    "* whoareyou\n",
    "    - utter_answer_whoareyou\n",
    "    \n",
    "## who are you\n",
    "* whoareyou\n",
    "    - utter_answer_whoareyou\n",
    "    \n",
    "## who are you with greet\n",
    "* greet\n",
    "    - utter_answer_greet\n",
    "* whoareyou\n",
    "    - utter_answer_whoareyou\n",
    "    \n",
    "## what to do\n",
    "* whattodo\n",
    "    - utter_answer_whattodo\n",
    "    \n",
    "## what to do with greet\n",
    "* greet\n",
    "    - utter_answer_greet\n",
    "* whattodo\n",
    "    - utter_answer_whattodo    \n",
    "    \n",
    "## happy path\n",
    "* request_weather\n",
    "    - weather_form\n",
    "    - form{\"name\": \"weather_form\"}\n",
    "    - form{\"name\": null}\n",
    "```"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "b3c47de0",
   "metadata": {},
   "source": [
    "### 2.4 domain\n",
    "```json\n",
    "intents:\n",
    "  - affirm\n",
    "  - deny\n",
    "  - greet\n",
    "  - goodbye\n",
    "  - thanks\n",
    "  - whoareyou\n",
    "  - whattodo\n",
    "  - request_weather\n",
    "\n",
    "slots:\n",
    "  date-time:\n",
    "    type: unfeaturized\n",
    "  address:\n",
    "    type: unfeaturized\n",
    "\n",
    "entities:\n",
    "  - date-time\n",
    "  - address\n",
    "\n",
    "actions:\n",
    "  - utter_answer_affirm\n",
    "  - utter_answer_deny\n",
    "  - utter_answer_greet\n",
    "  - utter_answer_goodbye\n",
    "  - utter_answer_thanks\n",
    "  - utter_answer_whoareyou\n",
    "  - utter_answer_whattodo\n",
    "  - utter_ask_date-time\n",
    "  - utter_ask_address\n",
    "  - action_default_fallback\n",
    "\n",
    "forms:\n",
    "  - weather_form\n",
    "\n",
    "responses:\n",
    "  utter_answer_affirm:\n",
    "    - text: \"嗯嗯，好的！\"\n",
    "    - text: \"嗯嗯，很开心能够帮您解决问题~\"\n",
    "    - text: \"嗯嗯，还需要什么我能够帮助您的呢？\"\n",
    "\n",
    "  utter_answer_greet:\n",
    "    - text: \"您好！请问我可以帮到您吗？\"\n",
    "    - text: \"您好！很高兴为您服务。请说出您要查询的功能？\"\n",
    "\n",
    "  utter_answer_goodbye:\n",
    "    - text: \"再见\"\n",
    "    - text: \"拜拜\"\n",
    "    - text: \"虽然我有万般舍不得，但是天下没有不散的宴席~祝您安好！\"\n",
    "    - text: \"期待下次再见！\"\n",
    "    - text: \"嗯嗯，下次需要时随时记得我哟~\"\n",
    "    - text: \"see you!\"\n",
    "\n",
    "  utter_answer_deny:\n",
    "    - text: \"主人，您不开心吗？不要离开我哦\"\n",
    "    - text: \"怎么了，主人？\"\n",
    "\n",
    "  utter_answer_thanks:\n",
    "    - text: \"嗯呢。不用客气~\"\n",
    "    - text: \"这是我应该做的，主人~\"\n",
    "    - text: \"嗯嗯，合作愉快！\"\n",
    "\n",
    "  utter_answer_whoareyou:\n",
    "    - text: \"您好！我是小蒋呀，您的AI智能助理\"\n",
    "\n",
    "  utter_answer_whattodo:\n",
    "    - text: \"您好！很高兴为您服务，我目前只支持查询天气哦。\"\n",
    "\n",
    "  utter_ask_date-time:\n",
    "    - text: \"请问您要查询哪一天的天气？\"\n",
    "\n",
    "  utter_ask_address:\n",
    "    - text: \"请问您要查下哪里的天气？\"\n",
    "\n",
    "  utter_default:\n",
    "    - text: \"没听懂，请换种说法吧~\"\n",
    "\n",
    "session_config:\n",
    "  session_expiration_time: 60\n",
    "  carry_over_slots_to_new_session: true\n",
    "```"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "606c4d1b",
   "metadata": {},
   "source": [
    "### 2.5 credential\n",
    "配置连接到其他服务的详细(认证)信息，当我们需要通过Http的形式访问Rasa Server时，就需要在该文件中配置rest:。rest通道将为您提供一个rest端点（即Rasa Server），用于向其发送消息，响应该请求将发送回bots消息.\n",
    "\n",
    "```json\n",
    "# This file contains the credentials for the voice & chat platforms\n",
    "# which your bot is using.\n",
    "# https://rasa.com/docs/rasa/user-guide/messaging-and-voice-channels/\n",
    "\n",
    "rest:\n",
    "#  # you don't need to provide anything here - this channel doesn't\n",
    "#  # require any credentials\n",
    "\n",
    "\n",
    "#facebook:\n",
    "#  verify: \"<verify>\"\n",
    "#  secret: \"<your secret>\"\n",
    "#  page-access-token: \"<your page access token>\"\n",
    "\n",
    "#slack:\n",
    "#  slack_token: \"<your slack token>\"\n",
    "#  slack_channel: \"<the slack channel>\"\n",
    "\n",
    "#socketio:\n",
    "#  user_message_evt: <event name for user message>\n",
    "#  bot_message_evt: <event name for but messages>\n",
    "#  session_persistence: <true/false>\n",
    "\n",
    "#mattermost:\n",
    "#  url: \"https://<mattermost instance>/api/v4\"\n",
    "#  token: \"<bot token>\"\n",
    "#  webhook_url: \"<callback URL>\"\n",
    "\n",
    "# This entry is needed if you are using Rasa X. The entry represents credentials \n",
    "# for the Rasa X \"channel\", i.e. Talk to your bot and Share with guest testers.\n",
    "# rasa:\n",
    "#   url: \"http://localhost:5002/api\"\n",
    "\n",
    "\n",
    "```"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "27d4727d",
   "metadata": {},
   "source": [
    "### 2.6 endpoints\n",
    "如果希望rasa server(注：指rasa core)能够连接到其他web，我们可以再endpoints.yml这个文件中进行配置，比如为了实现custom action，我们就需要在该文件中对action server进行配置，又比如我们将nlu模块放到其他的web项目中，就需要在该文件中配置nlu server等等。\n",
    "\n",
    "```json\n",
    "# This file contains the different endpoints your bot can use.\n",
    "\n",
    "# Server where the models are pulled from.\n",
    "# https://rasa.com/docs/rasa/user-guide/configuring-http-api/#fetching-models-from-a-server/\n",
    "\n",
    "#models:\n",
    "#  url: http://my-server.com/models/default_core@latest\n",
    "#  wait_time_between_pulls:  10   # [optional](default: 100)\n",
    "\n",
    "# Server which runs your custom actions.\n",
    "# https://rasa.com/docs/rasa/core/actions/#custom-actions/\n",
    "\n",
    "action_endpoint:\n",
    " url: \"http://localhost:5055/webhook\"\n",
    "\n",
    "# Tracker store which is used to store the conversations.\n",
    "# By default the conversations are stored in memory.\n",
    "# https://rasa.com/docs/rasa/api/tracker-stores/\n",
    "\n",
    "#tracker_store:\n",
    "#    type: redis\n",
    "#    url: <host of the redis instance, e.g. localhost>\n",
    "#    port: <port of your redis instance, usually 6379>\n",
    "#    db: <number of your database within redis, e.g. 0>\n",
    "#    password: <password used for authentication>\n",
    "#    use_ssl: <whether or not the communication is encrypted, default false>\n",
    "\n",
    "#tracker_store:\n",
    "#    type: mongod\n",
    "#    url: <url to your mongo instance, e.g. mongodb://localhost:27017>\n",
    "#    db: <name of the db within your mongo instance, e.g. rasa>\n",
    "#    username: <username used for authentication>\n",
    "#    password: <password used for authentication>\n",
    "\n",
    "# Event broker which all conversation events should be streamed to.\n",
    "# https://rasa.com/docs/rasa/api/event-brokers/\n",
    "\n",
    "#event_broker:\n",
    "#  url: localhost\n",
    "#  username: username\n",
    "#  password: password\n",
    "#  queue: queue\n",
    "```"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "8e0de7e2",
   "metadata": {},
   "source": [
    "### 2.7 actions\n",
    "一般情况是我们通过在线API去查询天气，这里为了方便演示，固定写好了回复。\n",
    "\n",
    "```json\n",
    "from typing import Dict, Text, Any, List\n",
    "\n",
    "from rasa_sdk import Tracker, Action\n",
    "from rasa_sdk.events import UserUtteranceReverted, Restarted\n",
    "from rasa_sdk.executor import CollectingDispatcher\n",
    "from rasa_sdk.forms import FormAction\n",
    "\n",
    "# action weather_form\n",
    "class WeatherForm(FormAction):\n",
    "\n",
    "    def name(self) -> Text:\n",
    "        \"\"\"Unique identifier of the form\"\"\"\n",
    "\n",
    "        return \"weather_form\"\n",
    "\n",
    "    @staticmethod\n",
    "    def required_slots(tracker: Tracker) -> List[Text]:\n",
    "        \"\"\"A list of required slots that the form has to fill\"\"\"\n",
    "\n",
    "        return [\"date-time\", \"address\"]\n",
    "\n",
    "    def submit(\n",
    "        self,\n",
    "        dispatcher: CollectingDispatcher,\n",
    "        tracker: Tracker,\n",
    "        domain: Dict[Text, Any],\n",
    "    ) -> List[Dict]:\n",
    "        \"\"\"Define what the form has to do\n",
    "            after all required slots are filled\"\"\"\n",
    "        address = tracker.get_slot('address')\n",
    "        date_time = tracker.get_slot('date-time')\n",
    "\n",
    "        date_time_number = \"20201026\"\n",
    "\n",
    "        weather_data = address + \"的天气在\" + date_time + \"非常好，20度，晴，微风。\"\n",
    "        dispatcher.utter_message(weather_data)\n",
    "        return [Restarted()]\n",
    "            \n",
    "            \n",
    "# action_default_fallback\n",
    "class ActionDefaultFallback(Action):\n",
    "    \"\"\"Executes the fallback action and goes back to the previous state\n",
    "    of the dialogue\"\"\"\n",
    "\n",
    "    def name(self):\n",
    "        return 'action_default_fallback'\n",
    "\n",
    "    def run(self, dispatcher, tracker, domain):\n",
    "        message = \"我还在开发中，请多多包含\"\n",
    "        if message is not None:\n",
    "            dispatcher.utter_message(message)\n",
    "        else:\n",
    "            dispatcher.utter_template('utter_default', tracker, silent_fail=True)\n",
    "        return [UserUtteranceReverted()]\n",
    "\n",
    "```"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "972dec2f",
   "metadata": {},
   "source": [
    "## 3. 训练\n",
    "```\n",
    "rasa train\n",
    "```"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "7e4b20f0",
   "metadata": {},
   "source": [
    "## 4. 启动\n",
    "### 4.1 启动action\n",
    "\n",
    ">rasa run actions --port 5055 --actions actions --debug\n",
    "\n",
    "![](./rasa_run_actions.png)\n",
    "\n",
    "### 4.2 启动shell\n",
    "\n",
    ">rasa shell\n",
    "\n",
    "![](./rasa_shell.png)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "6e60509f",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.7.13"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
